<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>곡성군 AI 민원상담봇</title>
    <meta name="description" content="곡성군 민원편람을 기반으로 정확한 정보를 제공하는 AI 상담 서비스">
    
    <!-- PWA 관련 -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0ea5e9">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏛️</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 조건부 라이브러리 로딩 (Cloudflare가 아닌 환경에서만) -->
    <script>
        // Cloudflare 환경 감지
        const isCloudflare = window.location.hostname.includes('.pages.dev') || 
                           window.location.hostname.includes('.workers.dev') || 
                           window.location.hostname.includes('cloudflare');
        
        if (!isCloudflare) {
            // PDF.js (로컬 환경에서만)
            const pdfScript = document.createElement('script');
            pdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
            pdfScript.onerror = () => console.warn('PDF.js 로드 실패');
            document.head.appendChild(pdfScript);
            
            // TensorFlow.js (로컬 환경에서만)
            const tfScript = document.createElement('script');
            tfScript.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js';
            tfScript.onerror = () => console.warn('TensorFlow.js 로드 실패');
            document.head.appendChild(tfScript);
            
            // Universal Sentence Encoder (로컬 환경에서만)
            const useScript = document.createElement('script');
            useScript.src = 'https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js';
            useScript.onerror = () => console.warn('USE 로드 실패');
            document.head.appendChild(useScript);
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translateY(0);
            }
            40%, 43% {
                transform: translateY(-10px);
            }
            70% {
                transform: translateY(-5px);
            }
        }
        
        .typing-content {
            min-height: 1.5rem;
        }
        
        /* PWA 설치 버튼 스타일 */
        .install-button {
            display: none;
        }
        
        .install-button.show {
            display: inline-flex;
        }
        
        /* 스크롤바 스타일링 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans">
    <!-- 메인 컨테이너 -->
    <div class="flex h-screen">
        <!-- 사이드바 (데스크톱) -->
        <div class="hidden lg:flex lg:w-80 bg-white border-r border-gray-200 flex-col">
            <!-- 헤더 -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                        🏛️
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">곡성군 AI 상담</h1>
                        <p class="text-sm text-gray-500">민원편람 기반 상담</p>
                    </div>
                </div>
                <p class="mt-3 text-sm text-gray-600">곡성군 민원편람을 기반으로 정확한 정보를 제공해드립니다</p>
            </div>
            
            <!-- 자주 묻는 질문 -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">자주 묻는 질문</h2>
                <div class="space-y-3">
                    <button class="suggested-question w-full text-left p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors" data-question="주민등록등본 발급 방법을 알려주세요">
                        <div class="text-sm font-medium text-gray-900">주민등록등본 발급</div>
                        <div class="text-xs text-gray-500 mt-1">발급 방법과 필요 서류</div>
                    </button>
                    
                    <button class="suggested-question w-full text-left p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors" data-question="건축허가 신청 절차를 알려주세요">
                        <div class="text-sm font-medium text-gray-900">건축허가 신청</div>
                        <div class="text-xs text-gray-500 mt-1">신청 절차와 구비서류</div>
                    </button>
                    
                    <button class="suggested-question w-full text-left p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors" data-question="복지 혜택 신청 방법을 알려주세요">
                        <div class="text-sm font-medium text-gray-900">복지 혜택 신청</div>
                        <div class="text-xs text-gray-500 mt-1">각종 복지 제도 안내</div>
                    </button>
                    
                    <button class="suggested-question w-full text-left p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors" data-question="지방세 납부 방법을 알려주세요">
                        <div class="text-sm font-medium text-gray-900">지방세 납부</div>
                        <div class="text-xs text-gray-500 mt-1">세금 납부 방법과 일정</div>
                    </button>
                    
                    <button class="suggested-question w-full text-left p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition-colors" data-question="농업 지원사업 신청은 어떻게 하나요?">
                        <div class="text-sm font-medium text-gray-900">농업 지원사업</div>
                        <div class="text-xs text-gray-500 mt-1">농업인 대상 지원 프로그램</div>
                    </button>
                </div>
            </div>
            
            <!-- 하단 정보 -->
            <div class="p-6 border-t border-gray-200">
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <span id="questionCount">질문 0개</span>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-circle text-xs" id="apiStatus"></i>
                        <span id="apiStatusText">API 키 미설정</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 메인 채팅 영역 -->
        <div class="flex-1 flex flex-col">
            <!-- 상단 헤더 (모바일) -->
            <div class="lg:hidden bg-white border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white">
                            🏛️
                        </div>
                        <div>
                            <h1 class="font-semibold text-gray-900">곡성군 AI 상담</h1>
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <span id="questionCountMobile">질문 0개</span>
                                <i class="fas fa-circle text-xs" id="apiStatusMobile"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="settingsBtn" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="helpBtn" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 데스크톱 상단 도구 모음 -->
            <div class="hidden lg:flex bg-white border-b border-gray-200 px-6 py-4 justify-between items-center">
                <div class="flex items-center space-x-4">
                    <button id="clearChat" class="flex items-center space-x-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-trash-alt"></i>
                        <span>대화 지우기</span>
                    </button>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button id="fileUploadBtn" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="PDF 파일 업로드">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="fileUpload" accept=".pdf" class="hidden">
                    
                    <button id="settingsBtn" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="설정">
                        <i class="fas fa-cog"></i>
                    </button>
                    
                    <button id="helpBtn" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" title="도움말">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
            
            <!-- 채팅 메시지 영역 -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-6 space-y-4">
                <!-- 초기 환영 메시지 -->
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                        AI
                    </div>
                    <div class="flex-1 max-w-xs lg:max-w-md">
                        <div class="bg-gray-100 rounded-lg px-4 py-2">
                            <p>안녕하세요! 곡성군 AI 민원상담봇입니다. 😊</p>
                            <p class="mt-2">곡성군 민원편람을 기반으로 정확한 정보를 제공해드립니다. 궁금한 것이 있으시면 언제든지 물어보세요!</p>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">방금 전</div>
                    </div>
                </div>
            </div>
            
            <!-- 메시지 입력 영역 -->
            <div class="bg-white border-t border-gray-200 p-4 lg:p-6">
                <div class="flex items-end space-x-4">
                    <div class="flex-1">
                        <textarea 
                            id="messageInput" 
                            placeholder="곡성군 민원 관련 질문을 입력해주세요..." 
                            class="w-full resize-none rounded-lg border border-gray-300 px-4 py-3 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                            rows="1"
                            maxlength="1000"></textarea>
                    </div>
                    <button 
                        id="sendButton" 
                        disabled
                        class="bg-blue-500 text-white rounded-lg px-6 py-3 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- 모바일 자주 묻는 질문 -->
                <div class="lg:hidden mt-4">
                    <div class="flex overflow-x-auto space-x-2 pb-2">
                        <button class="suggested-question flex-shrink-0 px-3 py-2 bg-gray-100 hover:bg-blue-100 rounded-full text-sm transition-colors" data-question="주민등록등본 발급 방법을 알려주세요">
                            주민등록등본 발급
                        </button>
                        <button class="suggested-question flex-shrink-0 px-3 py-2 bg-gray-100 hover:bg-blue-100 rounded-full text-sm transition-colors" data-question="건축허가 신청 절차를 알려주세요">
                            건축허가 신청
                        </button>
                        <button class="suggested-question flex-shrink-0 px-3 py-2 bg-gray-100 hover:bg-blue-100 rounded-full text-sm transition-colors" data-question="복지 혜택 신청 방법을 알려주세요">
                            복지 혜택
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 설정 모달 -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">설정</h2>
                <button id="closeSettings" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">
                        OpenAI API 키
                    </label>
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        placeholder="sk-..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">API 키는 브라우저에만 저장되며 외부로 전송되지 않습니다.</p>
                </div>
                
                <div>
                    <label for="typingSpeed" class="block text-sm font-medium text-gray-700 mb-1">
                        응답 속도
                    </label>
                    <input 
                        type="range" 
                        id="typingSpeed" 
                        min="0.01" 
                        max="0.1" 
                        step="0.01" 
                        value="0.02"
                        class="w-full">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>빠름</span>
                        <span>보통</span>
                        <span>느림</span>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button id="saveSettings" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    저장
                </button>
                <button id="cancelSettings" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    취소
                </button>
            </div>
        </div>
    </div>
    
    <!-- 도움말 모달 -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">도움말</h2>
                <button id="closeHelp" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">사용법</h3>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li>• 하단 입력창에 민원 관련 질문을 입력하세요</li>
                        <li>• 자주 묻는 질문을 클릭하여 빠르게 시작하세요</li>
                        <li>• Enter 키로 메시지를 전송할 수 있습니다</li>
                        <li>• Shift + Enter로 줄바꿈이 가능합니다</li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">주요 기능</h3>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li>• <strong>실시간 AI 상담:</strong> 24시간 언제든 질문 가능</li>
                        <li>• <strong>민원편람 기반:</strong> 정확한 곡성군 정보 제공</li>
                        <li>• <strong>자연스러운 대화:</strong> 타이핑 효과로 실제 상담원과 대화하는 느낌</li>
                        <li>• <strong>다양한 민원 지원:</strong> 증명서, 허가, 복지, 세금 등</li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">주요 민원 분야</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                        <div>• 주민등록, 가족관계 등록</div>
                        <div>• 건축, 토지 관련 인허가</div>
                        <div>• 복지 및 보조금 신청</div>
                        <div>• 세금 및 지방세</div>
                        <div>• 농업, 축산업 지원</div>
                        <div>• 교통, 도로 관련 민원</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">문의처</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm text-gray-600 space-y-1">
                            <div><strong>곡성군청:</strong> 061-360-8000</div>
                            <div><strong>주소:</strong> 전라남도 곡성군 곡성읍 군청로 31</div>
                            <div><strong>운영시간:</strong> 평일 09:00-18:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Service Worker 등록 -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('Service Worker 등록 성공:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker 등록 실패:', error);
                    });
            });
        }
    </script>
    
    <!-- 메인 애플리케이션 스크립트 -->
    <script src="./utils.js"></script>
    <script>
        // Cloudflare가 아닌 환경에서만 RAG 엔진 로드
        if (!window.location.hostname.includes('.pages.dev') && 
            !window.location.hostname.includes('.workers.dev') &&
            !window.location.hostname.includes('cloudflare')) {
            const script = document.createElement('script');
            script.src = './rag-engine.js';
            script.onerror = () => console.warn('RAG 엔진 로드 실패');
            document.head.appendChild(script);
        }
    </script>
    <script src="./main.js"></script>
    
    <!-- 앱 초기화 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.chatbot = new GokseongChatbot();
        });
    </script>
</body>
</html>

